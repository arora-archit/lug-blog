---
import { ClientRouter } from 'astro:transitions';
---

<header transition:persist="none">
	<ClientRouter />
	<a href="/" class="logo">
		<img src="/luglogo.png" alt="logo">
		<span>The LUGVITC Blog</span>
	</a>

	<button id="hamburger" class="hamburger" aria-label="Toggle navigation" aria-expanded="false">â˜°</button>

	<div id="menu" class="menu">
		<nav>
			<a href="/">cd ~</a>
			<a href="https://www.lugvitc.net">cd /</a>
			<a href="https://lugvitc.net/#/contact">ping lugvitc.net</a>
		</nav>
		<button id="toggle-theme" aria-label="Toggle theme"><img src="/Sun.svg" alt="Toggle theme"></button>
	</div>
</header>

<script is:inline>
	const getTheme = () => {
		if (localStorage.getItem("theme")) {
			return localStorage.getItem("theme");
		}
		if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
			return "dark";
		}
		return "light";
	};

	const applyTheme = (theme) => {
		document.documentElement.classList.toggle("dark", theme === "dark");
	};

	const updateIcon = (theme) => {
		const icon = document.querySelector("#toggle-theme img");
		if (icon) {
			icon.src = theme === "dark" ? "/Sun.svg" : "/Moon.svg";
		}
	};

	const handleToggleClick = () => {
		document.documentElement.classList.add("disable-transitions");

		const isDark = document.documentElement.classList.toggle("dark");
		const theme = isDark ? "dark" : "light";

		localStorage.setItem("theme", theme);
		updateIcon(theme);

		window.setTimeout(() => {
			document.documentElement.classList.remove("disable-transitions");
		}, 0);
	};

	const attachToggle = () => {
		const btn = document.getElementById("toggle-theme");
		if (btn) {
			btn.onclick = handleToggleClick;
		}
	};

	const attachMenuToggle = () => {
		const ham = document.getElementById('hamburger');
		const menu = document.getElementById('menu');
		if (!ham || !menu) return;

		ham.onclick = (e) => {
			e.stopPropagation();
			const opened = menu.classList.toggle('open');
			ham.setAttribute('aria-expanded', opened ? 'true' : 'false');
		};

		menu.querySelectorAll('a').forEach(a => a.addEventListener('click', () => {
			menu.classList.remove('open');
			ham.setAttribute('aria-expanded', 'false');
		}));

		document.addEventListener('click', (ev) => {
			if (!menu.classList.contains('open')) return;
			const target = ev.target;
			if (!menu.contains(target) && target !== ham) {
				menu.classList.remove('open');
				ham.setAttribute('aria-expanded', 'false');
			}
		});
	};

	const theme = getTheme();
	applyTheme(theme);
	updateIcon(theme);
	localStorage.setItem("theme", theme);

	const initHeader = () => {
		attachToggle();
		attachMenuToggle();
		applyTheme(getTheme());
	};

	if (!window.headerWidgetAttached) {
		document.addEventListener("astro:after-swap", () => {
			applyTheme(getTheme());
			updateIcon(getTheme());
		});

		document.addEventListener("astro:page-load", () => {
			initHeader();
		});

		window.headerWidgetAttached = true;
	}
</script>

<style>
	header {
		display:flex;
		align-items: center;
		gap: 2rem;
		padding:0.1rem 0.5rem 0.5rem;
		border-bottom:4px solid var(--header-border);
		color: white;
		background: var(--header-bg);
		position: relative;
	}

	.logo {
		display: flex;
		align-items: center;
		text-decoration:none;
		color:inherit;
		padding: 4px;
	}
	.logo img {
		height: 80px;
		width: auto;
	}

	.logo span {
		font-weight: 400;
		letter-spacing: 0.05em;
		line-height: 1;
		border:2px solid var(--color-border);
		padding:12px;
		background:var(--gray);
		box-shadow: 6px 6px var(--box-shadow);
	}

	.menu {
		margin-left: auto;
		display:flex;
		align-items: center;
		gap:1rem;
	}

	.menu nav {
		display:flex;
		gap:2rem;
	}

	.menu nav a {
		text-decoration:none;
		color: inherit;
		padding: 0.5rem 1.5rem;
		box-shadow: 6px 6px var(--box-shadow);
	}

	.menu nav a:nth-child(1) { background: var(--color-orange); }
	.menu nav a:nth-child(2) { background: var(--color-blue); }
	.menu nav a:nth-child(3) { background: var(--color-green); }

	#toggle-theme {
		display:flex;
		align-items:center;
		justify-content: center;
		padding:0.5rem 0.5rem;
		background: var(--color-orange);
		box-shadow: 6px 6px var(--box-shadow);
		margin-right: 12px;
		border: none;
		border-radius: 0;
		cursor: pointer;
	}

	#toggle-theme img { width: 32px; height: 32px; }

	header .menu nav a,
	#toggle-theme {
		transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
	}

	header .menu nav a:hover, #toggle-theme:hover {
		transform: translate(1px, 1px);
		box-shadow: 4px 4px var(--box-shadow);
	}

	.hamburger {
		display: none;
		margin-left: auto;
		background: var(--color-blue);
		color: white;
		border: none;
		padding: 0.5rem 0.75rem;
		font-size: 1.25rem;
		cursor: pointer;
		box-shadow: 6px 6px var(--box-shadow);
	}

	@media (max-width: 700px) {
		header {
			gap: 1rem;
		}

		.logo img { height: 56px; }

		.hamburger { display: block; }

		.menu { display: none; }

		.menu.open {
			display: flex;
			position: absolute;
			top: 100%;
			right: 12px;
			flex-direction: column;
			gap: 0.5rem;
			padding: 0.75rem;
			background: var(--header-bg);
			border: 4px solid var(--header-border);
			z-index: 60;
			min-width: 200px;
		}

		.menu nav { flex-direction: column; }
		.menu nav a { padding: 0.5rem 1rem; }
		#toggle-theme { margin-right: 0; }
	}

</style>
